name: CI/CD do Frontend Next.js

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # Job 1: Build e Lint
  build-and-lint:
    runs-on: ubuntu-latest
    name: Testar Build e Lint

    steps:
      - name: 1. Obter c√≥digo do reposit√≥rio
        uses: actions/checkout@v4

      - name: 2. Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20 # Use a vers√£o do Node que seu projeto usa

      - name: 3. Instalar depend√™ncias (npm)
        run: npm ci # 'ci' √© mais r√°pido e seguro para pipelines

      - name: 4. Executar An√°lise Est√°tica (Lint)
        run: npm run lint

      - name: 5. Executar Build de Produ√ß√£o
        run: npm run build

  # Job 2: Deploy (apenas na branch 'main')
  deploy:
    runs-on: ubuntu-latest
    name: Deploy no Servidor EC2
    needs: build-and-lint  # S√≥ executa se o job 'build-and-lint' passar
    if: github.ref == 'refs/heads/main' # S√≥ executa em push para a 'main'

    steps:
      - name: 1. Obter c√≥digo do reposit√≥rio
        uses: actions/checkout@v4

      - name: 2. Configurar Chave SSH
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.AWS_PRIVATE_KEY }}
          name: id_rsa
          known_hosts: |
            ${{ secrets.AWS_HOST }}

      - name: 3. Executar Script de Deploy na EC2
        run: |
          ssh -T -o StrictHostKeyChecking=no ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }} << 'EOF'
            # --- Gerenciamento de Vers√£o do Node ---
            # Carrega o NVM (Node Version Manager)
            # (Necess√°rio porque o SSH n√£o carrega o .bashrc por padr√£o)
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          
            # Navega para a pasta do frontend (ALTERE SE NECESS√ÅRIO)
            cd /var/www/report-frontend

            # Baixa as √∫ltimas mudan√ßas
            git pull origin main
          
            # Ativa a vers√£o correta do Node
            echo "Garantindo Node.js vers√£o 20..."
            nvm use 20

            # Instala depend√™ncias de produ√ß√£o
            echo "Instalando depend√™ncias..."
            npm ci

            # Gera o build de produ√ß√£o
            echo "Gerando build..."
            npm run build
          
            # Reinicia o servidor (Exemplo usando PM2)
            # Se voc√™ n√£o usa PM2, troque este comando pelo seu
            echo "Reiniciando aplica√ß√£o..."
            pm2 restart report-frontend 

            echo "üöÄ Deploy do Frontend conclu√≠do!"
          EOF

